<!DOCTYPE html>
<html lang="el">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KG Frost B2B Ordering</title>
  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      /* Colour palette inspired by the KG Frost logo */
      --gradient-start: #78cde9;
      --gradient-end: #4caed5;
      --primary-color: #49a5d3;
      --secondary-color: #6c7b8a;
      --success-color: #2ca55a;
      --danger-color: #e74c3c;
      --background: #ffffff;
      --card-bg: #ffffff;
      --shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 0;
      font-family: "Segoe UI", Tahoma, sans-serif;
      background: var(--background);
      color: #333;
    }
    header {
      padding: 1rem;
      background: linear-gradient(90deg, var(--gradient-start), var(--gradient-end));
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
    }
    header img {
      max-width: 160px;
      height: auto;
      margin-bottom: .5rem;
      /* Add background and padding so the logo stands out on the gradient */
      background: #ffffff;
      padding: .5rem;
      border-radius: 8px;
      box-shadow: var(--shadow);
    }
    main {
      padding: 1rem;
    }
    .hidden { display: none !important; }
    .message { margin: .5rem 0; padding: .5rem 1rem; border-radius: 4px; }
    .message.success { background: #d4edda; color: #155724; }
    .message.error { background: #f8d7da; color: #721c24; }
    /* Login */
    #loginSection {
      max-width: 400px;
      margin: 4rem auto;
      text-align: center;
    }
    #loginSection input {
      width: 100%;
      padding: .75rem;
      margin-bottom: .5rem;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    #loginSection button {
      width: 100%;
      padding: .75rem;
      background: var(--primary-color);
      color: #fff;
      border: none;
      border-radius: 4px;
      font-size: 1rem;
      cursor: pointer;
    }
    /* Tabs for admin */
    #adminTabs {
      display: flex;
      flex-wrap: wrap;
      margin-bottom: 1rem;
    }
    #adminTabs button {
      flex: 1 1 120px;
      padding: .5rem;
      margin-right: .5rem;
      border: 1px solid var(--primary-color);
      background: #fff;
      color: var(--primary-color);
      border-radius: 4px;
      cursor: pointer;
    }
    #adminTabs button.active {
      background: var(--primary-color);
      color: #fff;
    }
    /* Sections */
    section.card {
      padding: 1rem;
      margin-bottom: 1rem;
      background: var(--card-bg);
      box-shadow: var(--shadow);
      border-radius: 6px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 1rem;
    }
    th, td {
      padding: .5rem;
      border: 1px solid #dee2e6;
      text-align: left;
      white-space: nowrap;
    }
    th {
      background: #f8f9fa;
    }
    button.primary {
      background: var(--primary-color);
      color: #fff;
      border: none;
      padding: .4rem .8rem;
      border-radius: 4px;
      cursor: pointer;
    }
    button.danger {
      background: var(--danger-color);
      color: #fff;
      border: none;
      padding: .4rem .8rem;
      border-radius: 4px;
      cursor: pointer;
    }
    button.success {
      background: var(--success-color);
      color: #fff;
      border: none;
      padding: .4rem .8rem;
      border-radius: 4px;
      cursor: pointer;
    }

    /* Quantity controls styling */
    .cart-qty {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .cart-qty button {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      margin: 0 4px;
      font-size: 1.1rem;
    }
    .cart-qty span {
      min-width: 32px;
      text-align: center;
      font-size: 1rem;
    }

    /* Modal for order details */
    #orderModal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    #orderModal .modal-content {
      background: #fff;
      width: 90%;
      max-width: 500px;
      border-radius: 8px;
      padding: 1rem;
      position: relative;
      overflow-y: auto;
      max-height: 90%;
    }
    #orderModal .modal-content h4 {
      margin-top: 0;
    }
    #orderModal .close-btn {
      position: absolute;
      right: 0.5rem;
      top: 0.5rem;
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--danger-color);
    }
    #orderModal .print-btn {
      margin-top: 1rem;
      padding: .5rem 1rem;
      background: var(--primary-color);
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    /* Responsive adjustments */
    @media (max-width: 600px) {
      #adminTabs button {
        flex: 1 1 100%;
        margin: .25rem 0;
      }
      table { display: block; overflow-x: auto; }
    }

    /* User info display */
    #userInfo {
      font-size: 1rem;
      font-weight: 600;
      color: var(--secondary-color);
      margin-bottom: 0.5rem;
    }

    /* Highlight completed orders rows */
    tr.completed {
      background: var(--success-color);
      color: #fff;
    }
  </style>
</head>
<body>
  <header>
    <!-- Replace src with your logo file path or embed as base64 -->
    <img src="KG FROST LOGO without bg.png" alt="KG Frost logo">
  </header>
  <main>
    <section id="loginSection">
      <input id="afmInput" type="text" placeholder="Î‘Î¦Îœ" maxlength="9">
      <button id="loginBtn"><i class="fas fa-sign-in-alt"></i> Î£ÏÎ½Î´ÎµÏƒÎ·</button>
      <div id="loginMessage" class="message hidden"></div>
    </section>
    <section id="mainSection" class="hidden">
      <!-- User info and logout button -->
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.5rem;flex-wrap:wrap;">
        <div id="userInfo"></div>
        <button id="logoutBtn" class="danger" style=""><i class="fas fa-sign-out-alt"></i> Î‘Ï€Î¿ÏƒÏÎ½Î´ÎµÏƒÎ·</button>
      </div>
      <!-- Tabs will be inserted here -->
      <div id="adminTabs" class="hidden"></div>
      <!-- Create order section -->
      <section id="orderSection" class="card hidden">
        <div id="orderHeader" style="margin-bottom:.5rem;"></div>
        <table id="productsTable">
          <thead>
            <tr><th>Î ÏÎ¿ÏŠÏŒÎ½</th><th>Î•Î½Î­ÏÎ³ÎµÎ¹Î±</th></tr>
          </thead>
          <tbody id="productsBody"></tbody>
        </table>
        <h4>ÎšÎ±Î»Î¬Î¸Î¹</h4>
        <table>
          <thead>
            <tr><th>Î ÏÎ¿ÏŠÏŒÎ½</th><th>Î Î¿ÏƒÏŒÏ„Î·Ï„Î±</th><th>Î•Î½Î­ÏÎ³ÎµÎ¹Î±</th></tr>
          </thead>
          <tbody id="cartBody"></tbody>
        </table>
        <div id="cartSummary" style="margin:0.5rem 0;"></div>
        <!-- Notes for order -->
        <textarea id="orderNotes" placeholder="Î£Î·Î¼ÎµÎ¹ÏÏƒÎµÎ¹Ï‚ (Ï€ÏÎ¿Î±Î¹ÏÎµÏ„Î¹ÎºÎ¬)" style="width:100%;height:80px;margin:0.5rem 0;padding:.5rem;border:1px solid #ccc;border-radius:4px;resize:vertical;"></textarea>
        <button id="submitOrderBtn" class="success"><i class="fas fa-check-circle"></i> ÎŸÎ»Î¿ÎºÎ»Î®ÏÏ‰ÏƒÎ· Î Î±ÏÎ±Î³Î³ÎµÎ»Î¯Î±Ï‚</button>
        <div id="orderMessage" class="message hidden"></div>
      </section>
      <!-- Orders list section -->
      <section id="ordersSection" class="card hidden">
        <table>
          <thead>
            <tr><th>Î•Ï„Î±Î¹ÏÎµÎ¯Î±</th><th>Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±</th><th>ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·</th><th>Î•Î½Î­ÏÎ³ÎµÎ¹Î±</th></tr>
          </thead>
          <tbody id="ordersBody"></tbody>
        </table>
      </section>
      <!-- Add client section -->
      <section id="addClientSection" class="card hidden">
        <h4>Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· Ï€ÎµÎ»Î¬Ï„Î·</h4>
        <input id="clientNameInput" type="text" placeholder="ÎŒÎ½Î¿Î¼Î± ÎµÏ„Î±Î¹ÏÎµÎ¯Î±Ï‚">
        <input id="clientAfmInput" type="text" placeholder="Î‘Î¦Îœ" maxlength="9">
        <button id="addClientBtn" class="primary"><i class="fas fa-user-plus"></i> Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ·</button>
        <div id="clientMessage" class="message hidden"></div>

        <!-- List clients for admin -->
        <div id="clientListWrapper" style="margin-top:1rem;">
          <h4>Î ÎµÎ»Î¬Ï„ÎµÏ‚</h4>
          <input id="clientSearchInput" type="text" placeholder="Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ· Ï€ÎµÎ»Î¬Ï„Î·" style="width:100%;padding:.5rem;margin-bottom:.5rem;border:1px solid #ccc;border-radius:4px;">
          <table>
            <thead>
              <tr><th>ÎŒÎ½Î¿Î¼Î±</th><th>Î‘Î¦Îœ</th><th>Î•Î½Î­ÏÎ³ÎµÎ¹Î±</th></tr>
            </thead>
            <tbody id="clientsBody"></tbody>
          </table>
        </div>
      </section>
      <!-- Manage products section -->
      <section id="manageProductsSection" class="card hidden">
        <h4>Î”Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ· Ï€ÏÎ¿ÏŠÏŒÎ½Ï„Ï‰Î½</h4>
        <input id="productNameInput" type="text" placeholder="ÎŒÎ½Î¿Î¼Î± Ï€ÏÎ¿ÏŠÏŒÎ½Ï„Î¿Ï‚">
        <button id="addProductBtn" class="primary"><i class="fas fa-plus"></i> Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ·</button>
        <table>
          <thead>
            <tr><th>Î ÏÎ¿ÏŠÏŒÎ½</th><th>Î•Î½Î­ÏÎ³ÎµÎ¹Î±</th></tr>
          </thead>
          <tbody id="manageProductsBody"></tbody>
        </table>
        <div id="productMessage" class="message hidden"></div>
      </section>
    </section>
  </main>
  <!-- Success popup with confetti -->
  <div id="successPopup" class="hidden" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.4);display:flex;align-items:center;justify-content:center;z-index:9999;">
    <div style="background:#fff;padding:2rem;border-radius:6px;box-shadow:var(--shadow);text-align:center;position:relative;">
      <div id="successIcon" style="font-size:2rem;color:var(--success-color);">âœ”</div>
      <p id="successText" style="margin:.5rem 0 1rem 0;">Î•Ï€Î¹Ï„Ï…Ï‡Î®Ï‚ ÎºÎ±Ï„Î±Ï‡ÏÏÎ·ÏƒÎ·!</p>
      <button id="closePopupBtn" class="primary">ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿</button>
      <!-- Confetti container -->
      <div id="confettiContainer" style="position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;overflow:hidden;"></div>
    </div>
  </div>

  <!-- Welcome popup after login -->
  <div id="welcomePopup" class="hidden" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.4);display:flex;align-items:center;justify-content:center;z-index:9998;">
    <div style="background:#fff;padding:2rem;border-radius:6px;box-shadow:var(--shadow);text-align:center;">
      <div style="font-size:2rem;color:var(--primary-color);">ğŸ˜Š</div>
      <p style="margin:.5rem 0 0 0;font-weight:bold;">ÎšÎ±Î»ÏÏ‚ Î®ÏÎ¸Î±Ï„Îµ!</p>
    </div>
  </div>

  <!-- Modal for order details -->
  <div id="orderModal" class="hidden">
    <div class="modal-content">
      <button id="closeOrderModal" class="close-btn">&times;</button>
      <div id="orderDetailContent"></div>
      <button id="printOrderBtn" class="print-btn"><i class="fas fa-print"></i> Î•ÎºÏ„ÏÏ€Ï‰ÏƒÎ·</button>
    </div>
  </div>
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    // Supabase configuration
    const SUPABASE_URL = 'https://fonzuigghrctidyldwux.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZvbnp1aWdnaHJjdGlkeWxkd3V4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzExMDExMzcsImV4cCI6MjA4NjY3NzEzN30.HthrCioOrPGDdG60LCoJ1IvBCmD68ntb97nock6xY8Y';
    const SUPABASE_SERVICE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZvbnp1aWdnaHJjdGlkeWxkd3V4Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc3MTEwMTEzNywiZXhwIjoyMDg2Njc3MTM3fQ.9ssXpkn0l-ZriYFs5XwbrYQ8LJh8aZLLHgMVDMXNNj4';
    // Public client for normal queries
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    // Service role client for admin operations
    const supabaseAdmin = createClient(SUPABASE_URL, SUPABASE_SERVICE_KEY);

    // Global state
    let currentUser = null;
    let cart = {};
    let productMap = {};

    // Elements
    const loginSection = document.getElementById('loginSection');
    const mainSection = document.getElementById('mainSection');
    const loginBtn = document.getElementById('loginBtn');
    const afmInput = document.getElementById('afmInput');
    const loginMessage = document.getElementById('loginMessage');
    const logoutBtn = document.getElementById('logoutBtn');
    const adminTabs = document.getElementById('adminTabs');
    const orderSection = document.getElementById('orderSection');
    const ordersSection = document.getElementById('ordersSection');
    const addClientSection = document.getElementById('addClientSection');
    const manageProductsSection = document.getElementById('manageProductsSection');
    const productsBody = document.getElementById('productsBody');
    const cartBody = document.getElementById('cartBody');
    const cartSummary = document.getElementById('cartSummary');
    const submitOrderBtn = document.getElementById('submitOrderBtn');
    const orderMessage = document.getElementById('orderMessage');
    const ordersBody = document.getElementById('ordersBody');
    const clientNameInput = document.getElementById('clientNameInput');
    const clientAfmInput = document.getElementById('clientAfmInput');
    const addClientBtn = document.getElementById('addClientBtn');
    const clientMessage = document.getElementById('clientMessage');
    const productNameInput = document.getElementById('productNameInput');
    const addProductBtn = document.getElementById('addProductBtn');
    const manageProductsBody = document.getElementById('manageProductsBody');
    const productMessage = document.getElementById('productMessage');
    const clientSearchInput = document.getElementById('clientSearchInput');
    const clientsBody = document.getElementById('clientsBody');
    const successPopup = document.getElementById('successPopup');
    const closePopupBtn = document.getElementById('closePopupBtn');
    const confettiContainer = document.getElementById('confettiContainer');

    // Helper: show message
    function showMsg(el, text, type) {
      el.textContent = text;
      el.className = 'message ' + type;
      el.classList.remove('hidden');
      setTimeout(() => { el.classList.add('hidden'); }, 3000);
    }

    async function loginUser() {
      const afm = afmInput.value.trim();
      if (!afm || afm.length !== 9) {
        showMsg(loginMessage, 'Î•Î¹ÏƒÎ¬Î³ÎµÏ„Îµ Î­Î³ÎºÏ…ÏÎ¿ 9-ÏˆÎ®Ï†Î¹Î¿ Î‘Î¦Îœ.', 'error');
        return;
      }
      // Find user by AFM in profiles table
      // Use service role client to bypass RLS restrictions when looking up AFM
      const { data, error } = await supabaseAdmin
        .from('profiles')
        .select('*')
        .eq('afm', afm)
        .single();
      if (error || !data) {
        showMsg(loginMessage, 'Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚.', 'error');
        return;
      }
      currentUser = data;
      // Load interface
      loginSection.classList.add('hidden');
      mainSection.classList.remove('hidden');
      logoutBtn.style.display = 'inline-block';
      // Set user info display
      const infoEl = document.getElementById('userInfo');
      if (infoEl) {
        const name = currentUser.display_name || '';
        const afm = currentUser.afm || '';
        infoEl.textContent = name && afm ? `${name} (${afm})` : afm;
      }
      // Setup tabs based on role
      adminTabs.classList.remove('hidden');
      setupTabsForRole(currentUser.role);
      // Default tab is order
      showTab('order');
      await loadProducts();
      await loadOrders();

      // Preload clients list for admin
      if (currentUser.role === 'admin') {
        loadClients('');
      }

      // Show welcome popup briefly
      showWelcomePopup();
      // Start orders auto-refresh if admin
      if (currentUser.role === 'admin') {
        startOrdersRefresh();
      } else {
        stopOrdersRefresh();
      }
    }

    function setupTabsForRole(role) {
      adminTabs.innerHTML = '';
      let tabs;
      if (role === 'admin') {
        tabs = [
          { id: 'order', label: 'Î Î±ÏÎ±Î³Î³ÎµÎ»Î¯Î±' },
          { id: 'orders', label: 'Î Î±ÏÎ±Î³Î³ÎµÎ»Î¯ÎµÏ‚' },
          { id: 'client', label: 'Î ÎµÎ»Î¬Ï„ÎµÏ‚' },
          { id: 'products', label: 'Î ÏÎ¿ÏŠÏŒÎ½Ï„Î±' }
        ];
      } else {
        tabs = [
          { id: 'order', label: 'Î Î±ÏÎ±Î³Î³ÎµÎ»Î¯Î±' },
          { id: 'orders', label: 'Î™ÏƒÏ„Î¿ÏÎ¹ÎºÏŒ' }
        ];
      }
      const iconMap = {
        order: 'fa-cart-shopping',
        orders: role === 'admin' ? 'fa-clipboard-list' : 'fa-history',
        client: 'fa-users',
        products: 'fa-box-open'
      };
      tabs.forEach(tab => {
        const btn = document.createElement('button');
        const icon = iconMap[tab.id] || 'fa-circle';
        btn.innerHTML = `<i class="fas ${icon}"></i> ${tab.label}`;
        btn.addEventListener('click', () => {
          document.querySelectorAll('#adminTabs button').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          showTab(tab.id);
        });
        adminTabs.appendChild(btn);
      });
    }

    function showTab(id) {
      // Hide all
      orderSection.classList.add('hidden');
      ordersSection.classList.add('hidden');
      addClientSection.classList.add('hidden');
      manageProductsSection.classList.add('hidden');
      // Show selected
      if (id === 'order') orderSection.classList.remove('hidden');
      if (id === 'orders') ordersSection.classList.remove('hidden');
      if (id === 'client') addClientSection.classList.remove('hidden');
      if (id === 'products') manageProductsSection.classList.remove('hidden');
      // When showing client tab, load clients
      if (id === 'client') {
        loadClients('');
      }
    }

    async function loadProducts() {
      // Use service role for reading products as anon cannot read due to RLS
      const { data, error } = await supabaseAdmin.from('products').select('*').eq('is_active', true).order('name');
      if (error) {
        console.error(error);
        return;
      }
      productsBody.innerHTML = '';
      manageProductsBody.innerHTML = '';
      data.forEach(prod => {
        // Product list row (no ID column)
        const row = document.createElement('tr');
        const nameCell = document.createElement('td'); nameCell.textContent = prod.name;
        const actionCell = document.createElement('td');
        const addBtn = document.createElement('button'); addBtn.className='primary'; addBtn.innerHTML = '<i class="fas fa-plus"></i> Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ·';
        addBtn.addEventListener('click', () => {
          cart[prod.id] = (cart[prod.id] || 0) + 1;
          updateCart();
        });
        actionCell.appendChild(addBtn);
        row.appendChild(nameCell);
        row.appendChild(actionCell);
        productsBody.appendChild(row);
        // store product name in map
        productMap[prod.id] = prod.name;
        // Manage products list
        const row2 = document.createElement('tr');
        const nameCell2 = document.createElement('td'); nameCell2.textContent = prod.name;
        const actionCell2 = document.createElement('td');
        const deleteBtn = document.createElement('button'); deleteBtn.className='danger'; deleteBtn.innerHTML='<i class="fas fa-trash"></i> Î”Î¹Î±Î³ÏÎ±Ï†Î®';
        deleteBtn.addEventListener('click', async () => {
          if (!confirm('Î£Î¯Î³Î¿Ï…ÏÎ± Î´Î¹Î±Î³ÏÎ±Ï†Î®;')) return;
          const { error: delErr } = await supabaseAdmin.from('products').update({ is_active: false }).eq('id', prod.id);
          if (delErr) {
            showMsg(productMessage, 'Î£Ï†Î¬Î»Î¼Î± ÏƒÏ„Î· Î´Î¹Î±Î³ÏÎ±Ï†Î®.', 'error');
          } else {
            showMsg(productMessage, 'Î”Î¹Î±Î³ÏÎ¬Ï†Î·ÎºÎµ Ï„Î¿ Ï€ÏÎ¿ÏŠÏŒÎ½.', 'success');
            loadProducts();
          }
        });
        actionCell2.appendChild(deleteBtn);
        row2.appendChild(nameCell2);
        row2.appendChild(actionCell2);
        manageProductsBody.appendChild(row2);
      });
      updateCart();
    }

    function updateCart() {
      cartBody.innerHTML = '';
      let totalQty = 0;
      Object.entries(cart).forEach(([pid, qty]) => {
        const row = document.createElement('tr');
        const nameCell = document.createElement('td'); nameCell.textContent = productMap[pid] || pid;
        const qtyCell = document.createElement('td');
        qtyCell.className = 'cart-qty';
        const minusBtn = document.createElement('button'); minusBtn.innerHTML = '<i class="fas fa-minus"></i>'; minusBtn.className='secondary';
        const qtyInput = document.createElement('input');
        qtyInput.type = 'number';
        qtyInput.min = 1;
        qtyInput.value = qty;
        qtyInput.style.width = '50px';
        qtyInput.style.textAlign = 'center';
        const plusBtn = document.createElement('button'); plusBtn.innerHTML = '<i class="fas fa-plus"></i>'; plusBtn.className='secondary';
        minusBtn.addEventListener('click', () => {
          cart[pid] = Math.max(0, cart[pid] - 1);
          if (cart[pid] === 0) delete cart[pid];
          updateCart();
        });
        plusBtn.addEventListener('click', () => {
          cart[pid] = cart[pid] + 1;
          updateCart();
        });
        qtyInput.addEventListener('change', () => {
          let val = parseInt(qtyInput.value);
          if (isNaN(val) || val < 1) {
            delete cart[pid];
          } else {
            cart[pid] = val;
          }
          updateCart();
        });
        qtyCell.appendChild(minusBtn);
        qtyCell.appendChild(qtyInput);
        qtyCell.appendChild(plusBtn);
        const removeCell = document.createElement('td');
        const removeBtn = document.createElement('button'); removeBtn.className='danger'; removeBtn.innerHTML='<i class="fas fa-trash"></i>';
        removeBtn.addEventListener('click', () => { delete cart[pid]; updateCart(); });
        removeCell.appendChild(removeBtn);
        row.appendChild(nameCell);
        row.appendChild(qtyCell);
        row.appendChild(removeCell);
        cartBody.appendChild(row);
        totalQty += qty;
      });
      cartSummary.textContent = 'Î£ÏÎ½Î¿Î»Î¿ Ï„ÎµÎ¼Î±Ï‡Î¯Ï‰Î½: ' + totalQty;
    }

    async function submitOrder() {
      if (Object.keys(cart).length === 0) {
        showMsg(orderMessage, 'Î¤Î¿ ÎºÎ±Î»Î¬Î¸Î¹ ÎµÎ¯Î½Î±Î¹ Î¬Î´ÎµÎ¹Î¿.', 'error');
        return;
      }
      // Create order
      const notes = document.getElementById('orderNotes').value.trim();
      const { data: order, error: orderErr } = await supabaseAdmin.from('orders').insert({
        company_id: currentUser.company_id,
        created_by: currentUser.id,
        status: 'pending',
        notes: notes || null
      }).select().single();
      if (orderErr) {
        showMsg(orderMessage, 'Î£Ï†Î¬Î»Î¼Î± Ï€Î±ÏÎ±Î³Î³ÎµÎ»Î¯Î±Ï‚.', 'error');
        return;
      }
      // Insert order items
      const items = Object.entries(cart).map(([pid, qty]) => ({ order_id: order.id, product_id: pid, quantity: qty }));
      const { error: itemsErr } = await supabaseAdmin.from('order_items').insert(items);
      if (itemsErr) {
        showMsg(orderMessage, 'Î£Ï†Î¬Î»Î¼Î± ÏƒÏ„Î± ÎµÎ¯Î´Î·.', 'error');
        return;
      }
      // Clear cart
      cart = {};
      updateCart();
      // Clear notes
      document.getElementById('orderNotes').value = '';
      showSuccessPopup('Î— Ï€Î±ÏÎ±Î³Î³ÎµÎ»Î¯Î± ÎºÎ±Ï„Î±Ï‡Ï‰ÏÎ®Î¸Î·ÎºÎµ.');
      await loadOrders();
      // Redirect to history tab for non-admin users
      if (currentUser.role !== 'admin') {
        // Wait a moment to ensure orders are loaded then show orders tab
        showTab('orders');
      }
    }

    async function loadOrders() {
      let query = supabaseAdmin.from('orders').select('id, company_id, created_at, status, company:company_id(name)').order('created_at', { ascending: false });
      if (currentUser.role !== 'admin') {
        query = query.eq('company_id', currentUser.company_id);
      }
      const { data, error } = await query;
      if (error) { console.error(error); return; }
      ordersBody.innerHTML = '';
      data.forEach(order => {
        const row = document.createElement('tr');
        // Highlight completed rows for admin
        if (currentUser.role === 'admin' && order.status === 'completed') {
          row.classList.add('completed');
        }
        const companyCell = document.createElement('td'); companyCell.textContent = order.company.name;
        const dateCell = document.createElement('td'); dateCell.textContent = new Date(order.created_at).toLocaleString();
        const statusCell = document.createElement('td'); statusCell.textContent = order.status;
        const actionCell = document.createElement('td');
        const viewBtn = document.createElement('button'); viewBtn.className='primary'; viewBtn.innerHTML = '<i class="fas fa-eye"></i> Î ÏÎ¿Î²Î¿Î»Î®';
        viewBtn.addEventListener('click', () => { viewOrder(order.id); });
        actionCell.appendChild(viewBtn);
        if (currentUser.role === 'admin' && order.status === 'pending') {
          const completeBtn = document.createElement('button'); completeBtn.className='success'; completeBtn.innerHTML = '<i class="fas fa-check"></i> ÎŸÎ»Î¿ÎºÎ»Î®ÏÏ‰ÏƒÎ·';
          completeBtn.addEventListener('click', async () => {
            const { error: updErr } = await supabaseAdmin.from('orders').update({ status: 'completed', completed_at: new Date().toISOString() }).eq('id', order.id);
            if (!updErr) {
              await loadOrders();
            }
          });
          actionCell.appendChild(completeBtn);
        }
        row.appendChild(companyCell);
        row.appendChild(dateCell);
        row.appendChild(statusCell);
        row.appendChild(actionCell);
        ordersBody.appendChild(row);
      });
    }

    async function viewOrder(orderId) {
      // Fetch order and items
      const { data: order, error } = await supabaseAdmin.from('orders').select('id, company_id, created_at, status, notes, company:company_id(name), order_items(order_id, product_id, quantity, product:product_id(name))').eq('id', orderId).single();
      if (error) { console.error(error); return; }
      // Build modal content
      let html = `<h4>Î Î±ÏÎ±Î³Î³ÎµÎ»Î¯Î± ${order.id}</h4>`;
      html += `<p><strong>Î•Ï„Î±Î¹ÏÎµÎ¯Î±:</strong> ${order.company.name}<br><strong>ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·:</strong> ${order.status}<br><strong>Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±:</strong> ${new Date(order.created_at).toLocaleString()}</p>`;
      if (order.notes) {
        html += `<p><strong>Î£Î·Î¼ÎµÎ¹ÏÏƒÎµÎ¹Ï‚:</strong> ${order.notes}</p>`;
      }
      html += '<table style="width:100%;border-collapse:collapse;">';
      html += '<thead><tr><th style="border:1px solid #dee2e6;padding:.25rem .5rem;">Î ÏÎ¿ÏŠÏŒÎ½</th><th style="border:1px solid #dee2e6;padding:.25rem .5rem;">Î Î¿ÏƒÏŒÏ„Î·Ï„Î±</th></tr></thead>';
      html += '<tbody>';
      order.order_items.forEach(item => {
        html += `<tr><td style="border:1px solid #dee2e6;padding:.25rem .5rem;">${item.product.name}</td><td style="border:1px solid #dee2e6;padding:.25rem .5rem;">${item.quantity}</td></tr>`;
      });
      html += '</tbody></table>';
      // Insert into modal and show
      const contentEl = document.getElementById('orderDetailContent');
      contentEl.innerHTML = html;
      document.getElementById('orderModal').classList.remove('hidden');
    }

    async function addClient() {
      const name = clientNameInput.value.trim();
      const afm = clientAfmInput.value.trim();
      if (!name || afm.length !== 9) {
        showMsg(clientMessage, 'Î£Ï…Î¼Ï€Î»Î·ÏÏÏƒÏ„Îµ ÏŒÎ»Î± Ï„Î± Ï€ÎµÎ´Î¯Î±.', 'error');
        return;
      }
      // Check if AFM already exists
      const { data: existingProfiles, error: existingErr } = await supabaseAdmin.from('profiles').select('id').eq('afm', afm);
      if (existingProfiles && existingProfiles.length > 0) {
        showMsg(clientMessage, 'ÎŸ Ï€ÎµÎ»Î¬Ï„Î·Ï‚ Î¼Îµ Î±Ï…Ï„ÏŒ Ï„Î¿ Î‘Î¦Îœ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ Î®Î´Î·.', 'error');
        return;
      }
      // Insert company
      const { data: comp, error: compErr } = await supabaseAdmin.from('companies').insert({ name, afm }).select().single();
      if (compErr) { showMsg(clientMessage, 'Î£Ï†Î¬Î»Î¼Î± ÎµÏ„Î±Î¹ÏÎµÎ¯Î±Ï‚.', 'error'); return; }
      try {
        // Generate simple password (not used for login but required by Supabase auth)
        const randomPass = Math.random().toString(36).substring(2, 10) + Math.random().toString(36).substring(2, 10);
        // Create auth user for client
        const { data: userResponse, error: authErr } = await supabaseAdmin.auth.admin.createUser({ email: `${afm}@kgfrost.local`, password: randomPass });
        if (authErr || !userResponse || !userResponse.user) {
          showMsg(clientMessage, 'Î£Ï†Î¬Î»Î¼Î± Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î±Ï‚ Ï‡ÏÎ®ÏƒÏ„Î·.', 'error');
          return;
        }
        const userId = userResponse.user.id;
        // Insert profile with the new auth user id
        const { error: profErr } = await supabaseAdmin.from('profiles').insert({ id: userId, afm, company_id: comp.id, role: 'customer', display_name: name });
        if (profErr) { showMsg(clientMessage, 'Î£Ï†Î¬Î»Î¼Î± Ï€ÏÎ¿Ï†Î¯Î».', 'error'); return; }
        showMsg(clientMessage, 'ÎŸ Ï€ÎµÎ»Î¬Ï„Î·Ï‚ Ï€ÏÎ¿ÏƒÏ„Î­Î¸Î·ÎºÎµ.', 'success');
        clientNameInput.value = '';
        clientAfmInput.value = '';
        // Refresh clients list
        loadClients(clientSearchInput ? clientSearchInput.value.trim() : '');
      } catch (err) {
        showMsg(clientMessage, 'Î£Ï†Î¬Î»Î¼Î± ÎºÎ±Ï„Î¬ Ï„Î·Î½ Ï€ÏÎ¿ÏƒÎ¸Î®ÎºÎ·.', 'error');
      }
    }

    async function addProduct() {
      const name = productNameInput.value.trim();
      if (!name) { showMsg(productMessage, 'Î£Ï…Î¼Ï€Î»Î·ÏÏÏƒÏ„Îµ ÏŒÎ½Î¿Î¼Î±.', 'error'); return; }
      const { error } = await supabaseAdmin.from('products').insert({ name });
      if (error) { showMsg(productMessage, 'Î£Ï†Î¬Î»Î¼Î± Ï€ÏÎ¿ÏƒÎ¸Î®ÎºÎ·Ï‚.', 'error'); return; }
      showMsg(productMessage, 'Î¤Î¿ Ï€ÏÎ¿ÏŠÏŒÎ½ Ï€ÏÎ¿ÏƒÏ„Î­Î¸Î·ÎºÎµ.', 'success');
      productNameInput.value = '';
      loadProducts();
    }

    // Success popup and confetti
    function showSuccessPopup(text) {
      successPopup.classList.remove('hidden');
      document.getElementById('successText').textContent = text;
      // generate confetti
      confettiContainer.innerHTML = '';
      for (let i = 0; i < 30; i++) {
        const conf = document.createElement('div');
        conf.style.position = 'absolute';
        conf.style.width = '8px';
        conf.style.height = '8px';
        conf.style.borderRadius = '50%';
        conf.style.backgroundColor = ['#49a5d3','#2ca55a','#e74c3c','#ffc107'][i % 4];
        conf.style.left = '50%';
        conf.style.top = '50%';
        conf.style.transform = 'translate(-50%, -50%)';
        conf.style.opacity = '1';
        const dx = (Math.random() - 0.5) * 200;
        const dy = (Math.random() - 0.5) * 200;
        const duration = 700 + Math.random() * 300;
        conf.animate([
          { transform: 'translate(-50%, -50%)', opacity: 1 },
          { transform: `translate(${dx}px, ${dy}px)`, opacity: 0 }
        ], { duration, easing: 'ease-out', fill: 'forwards' });
        confettiContainer.appendChild(conf);
      }
    }
    closePopupBtn.addEventListener('click', () => {
      successPopup.classList.add('hidden');
    });

    // Welcome popup
    const welcomePopup = document.getElementById('welcomePopup');
    function showWelcomePopup() {
      if (!welcomePopup) return;
      welcomePopup.classList.remove('hidden');
      setTimeout(() => {
        welcomePopup.classList.add('hidden');
      }, 1000);
    }

    // Orders refresh interval for admin
    let ordersRefreshInterval = null;
    function startOrdersRefresh() {
      stopOrdersRefresh();
      ordersRefreshInterval = setInterval(() => {
        if (currentUser && currentUser.role === 'admin') {
          loadOrders();
        }
      }, 15000);
    }
    function stopOrdersRefresh() {
      if (ordersRefreshInterval) {
        clearInterval(ordersRefreshInterval);
        ordersRefreshInterval = null;
      }
    }

    // Order modal close & print handlers
    const orderModal = document.getElementById('orderModal');
    const closeOrderModalBtn = document.getElementById('closeOrderModal');
    const printOrderBtn = document.getElementById('printOrderBtn');
    closeOrderModalBtn.addEventListener('click', () => {
      orderModal.classList.add('hidden');
    });
    printOrderBtn.addEventListener('click', () => {
      // Print current modal content
      window.print();
    });

    // Load clients list for admin with optional search term
    async function loadClients(searchTerm = '') {
      if (!clientsBody) return;
      let query = supabaseAdmin
        .from('profiles')
        .select('id, afm, display_name, company_id, company:company_id(name)')
        .eq('role', 'customer');
      if (searchTerm) {
        // search by display_name or company name case-insensitive
        query = query.ilike('display_name', `%${searchTerm}%`);
      }
      const { data, error } = await query.order('display_name');
      if (error) {
        console.error('loadClients error', error);
        return;
      }
      clientsBody.innerHTML = '';
      (data || []).forEach(client => {
        const row = document.createElement('tr');
        const name = client.display_name || (client.company ? client.company.name : '');
        const nameCell = document.createElement('td'); nameCell.textContent = name;
        const afmCell = document.createElement('td'); afmCell.textContent = client.afm;
        const actionCell = document.createElement('td');
        const deleteBtn = document.createElement('button'); deleteBtn.className = 'danger'; deleteBtn.innerHTML = '<i class="fas fa-trash"></i> Î”Î¹Î±Î³ÏÎ±Ï†Î®';
        deleteBtn.addEventListener('click', async () => {
          if (!confirm('Î£Î¯Î³Î¿Ï…ÏÎ± Î´Î¹Î±Î³ÏÎ±Ï†Î® Ï€ÎµÎ»Î¬Ï„Î·;')) return;
          // Delete user from auth and profiles and company
          try {
            // Remove from auth
            await supabaseAdmin.auth.admin.deleteUser(client.id);
          } catch (err) {
            console.error('delete auth user error', err);
          }
          // Delete profile
          await supabaseAdmin.from('profiles').delete().eq('id', client.id);
          // Delete company if exists
          if (client.company_id) {
            await supabaseAdmin.from('companies').delete().eq('id', client.company_id);
          }
          loadClients(clientSearchInput ? clientSearchInput.value.trim() : '');
        });
        actionCell.appendChild(deleteBtn);
        row.appendChild(nameCell);
        row.appendChild(afmCell);
        row.appendChild(actionCell);
        clientsBody.appendChild(row);
      });
    }

    // Event listeners
    loginBtn.addEventListener('click', loginUser);
    logoutBtn.addEventListener('click', () => {
      currentUser = null;
      cart = {};
      mainSection.classList.add('hidden');
      loginSection.classList.remove('hidden');
      afmInput.value = '';
      stopOrdersRefresh();
    });
    submitOrderBtn.addEventListener('click', submitOrder);
    addClientBtn.addEventListener('click', addClient);
    addProductBtn.addEventListener('click', addProduct);

    // Search clients listener
    if (clientSearchInput) {
      clientSearchInput.addEventListener('input', () => {
        loadClients(clientSearchInput.value.trim());
      });
    }
  </script>
</body>
</html>
